{% extends "/api/base.html.jinja" %}
{% block content %}

<div id="infoModalsContainer"></div>
<div class="flex flex-row w-full min-h-[500px] shadow-2xl rounded-lg overflow-hidden border border-zinc-800">
  <!-- Left: Form -->
  <div id="sidebar"
    class="min-w-[150px] max-w-[600px] w-[300px] pr-6 bg-gradient-to-b from-zinc-800 to-zinc-900 pl-2 pt-2 pb-2 transition-all duration-100 ease-in-out">
    <div class="overflow-y-auto">
      <form id="screenerForm" autocomplete="off" class="sticky top-0 z-10">
        <div class="mb-5">
          <label for="theme" class="block mb-2 font-bold text-md text-white">
            <span>Theme:</span>
            <button type="button" class="text-blue-500 text-sm" onclick="showInfoModal('theme')"
              title="Info about Theme">ⓘ</button>
          </label>
          <input type="text" id="theme"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-md rounded-lg block w-full p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
            placeholder="{{ theme }}" required value="{{ theme }}" />
        </div>

        <div class="mb-5">
          <label for="focus" class="block mb-2 font-bold text-md text-white">
            <span>Focus:</span>
            <button type="button" class="text-blue-500 text-sm" onclick="showInfoModal('focus')"
              title="Info about Focus">ⓘ</button>
          </label>
          <textarea id="focus"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-md rounded-lg block w-full p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all min-h-[80px]"
            placeholder="{{ focus }}" required>{{ focus }}</textarea>
        </div>

        <div class="mb-5">
          <label for="companies" class="block mb-2 font-bold text-md text-white">
            <span>Company Universe:</span>
            <button type="button" class="text-blue-500 text-sm" onclick="showInfoModal('companies')"
              title="Info about Company Universe">ⓘ</button>
          </label>
          <div class="relative"> <!-- dropdown -->
            <input id="companies_text" type="text"
              class="absolute w-[calc(100%-20px)] bg-gray-50 text-gray-900 text-md rounded-lg block p-2.5 h-[42px] focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
            <select id="companies"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-md rounded-lg block w-full p-2.5 h-[42px] z-10 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer transition-all"
              onchange="this.previousElementSibling.value=this.options[this.selectedIndex].text;">
              <!-- Options are added in a javascript-->
            </select>
          </div>
        </div>

        <button type="button" onclick="toggleAdvancedOptions()" id="advancedOptionsBtn"
          class="flex items-center gap-2 text-white bg-gray-600 hover:bg-gray-700 font-medium rounded-lg text-base px-3 py-1.5 mb-2 transition-colors duration-200">
          <span id="advancedOptionsIcon" class="text-2xl font-bold">+</span>
          <span>Advanced Options</span>
        </button>

        <div id="advanced-options" class="hidden mt-4">
          <div class="mb-5">
            <label for="start_date" class="block mb-2 font-bold text-md text-white">
              <span>Start Date:</span>
              <button type="button" class="text-blue-500 text-sm" onclick="showInfoModal('start_date')"
                title="Info about Start Date">ⓘ</button>
            </label>
            <input type="date" id="start_date"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-md rounded-lg block w-full p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
              placeholder="{{ start_date }}" required value="{{ start_date }}" />
          </div>

          <div class="mb-5">
            <label for="end_date" class="block mb-2 font-bold text-md text-white">
              <span>End Date:</span>
              <button type="button" class="text-blue-500 text-sm" onclick="showInfoModal('end_date')"
                title="Info about End Date">ⓘ</button>
            </label>
            <input type="date" id="end_date"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-md rounded-lg block w-full p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
              placeholder="{{ end_date }}" required value="{{ end_date }}" />
          </div>

          <div class="mb-5">
            <label for="frequency" class="block mb-2 font-bold text-md text-white">
              <span>Frequency:</span>
              <button type="button" class="text-blue-500 text-sm" onclick="showInfoModal('frequency')"
                title="Info about Frequency">ⓘ</button>
            </label>
            <select id="frequency"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-md rounded-lg block w-full p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer transition-all">
              <option value="D" {% if frequency=='D' %}selected{% endif %}>Daily</option>
              <option value="W" {% if frequency=='W' %}selected{% endif %}>Weekly</option>
              <option value="M" {% if frequency=='M' %}selected{% endif %}>Monthly</option>
              <option value="3M" {% if frequency=='3M' %}selected{% endif %}>Quarterly</option>
              <option value="Y" {% if frequency=='Y' %}selected{% endif %}>Yearly</option>
            </select>
          </div>

          <div class="hidden mb-5">
            <label for="fiscal_year" class="block mb-2 font-bold text-md text-white">
              <span>Fiscal Year:</span>
              <button type="button" class="text-blue-500 text-sm" onclick="showInfoModal('fiscal_year')"
                title="Info about Fiscal Year">ⓘ</button>
            </label>
            <input type="text" id="fiscal_year"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-md rounded-lg block w-full p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
              placeholder="e.g. 2025"
              value="{% if fiscal_year %}{% if fiscal_year is iterable and fiscal_year is not string %}{{ fiscal_year|join(', ') }}{% else %}{{ fiscal_year }}{% endif %}{% endif %}" />
          </div>

          <div class="hidden mb-5">
            <label for="llm_model" class="block mb-2 font-bold text-md text-white">
              <span>LLM Model:</span>
              <button type="button" class="text-blue-500 text-sm" onclick="showInfoModal('llm_model')"
                title="Info about LLM Model">ⓘ</button>
            </label>
            <input type="text" id="llm_model"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-md rounded-lg block w-full p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
              placeholder="{{ llm_model }}" value="{{ llm_model }}" />
          </div>

          <div class="mb-5">
            <label for="document_type" class="hidden block mb-2 font-bold text-md text-white">
              <span>Document Type:</span>
              <button type="button" class="text-blue-500 text-sm" onclick="showInfoModal('document_type')"
                title="Info about Document Type">ⓘ</button>
            </label>
            <select id="document_type"
              class="hidden bg-gray-50 border border-gray-300 text-gray-900 text-md rounded-lg block w-full p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 cursor-pointer transition-all">
              <option value="all" {% if document_type=='all' %}selected{% endif %}>ALL</option>
              <option value="filings" {% if document_type=='filings' %}selected{% endif %}>FILINGS</option>
              <option value="transcripts" {% if document_type=='transcripts' %}selected{% endif %}>TRANSCRIPTS</option>
              <option value="news" {% if document_type=='news' %}selected{% endif %}>NEWS</option>
              <option value="files" {% if document_type=='files' %}selected{% endif %}>FILES</option>
            </select>
          </div>

          <div class="mb-5">
            <label for="rerank_threshold" class="block mb-2 font-bold text-md text-white">
              <span>Rerank Threshold (0-1):</span>
              <button type="button" class="text-blue-500 text-sm" onclick="showInfoModal('rerank_threshold')"
                title="Info about Rerank Threshold">ⓘ</button>
            </label>
            <input type="number" id="rerank_threshold"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-md rounded-lg block w-full p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
              placeholder="{{ rerank_threshold if rerank_threshold is defined and rerank_threshold is not none else '' }}"
              value="{{ rerank_threshold if rerank_threshold is defined and rerank_threshold is not none else '' }}"
              max="1" min="0" step="0.01">
          </div>

          <div class="mb-5">
            <label for="document_limit" class="block mb-2 font-bold text-md text-white">
              <span>Document Limit:</span>
              <button type="button" class="text-blue-500 text-sm" onclick="showInfoModal('document_limit')"
                title="Info about Document Limit">ⓘ</button>
            </label>
            <input type="number" id="document_limit"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-md rounded-lg block w-full p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
              placeholder="{{ document_limit }}" value="{{ document_limit }}" />
          </div>

          <div class="mb-5">
            <label for="batch_size" class="block mb-2 font-bold text-md text-white">
              <span>Batch Size:</span>
              <button type="button" class="text-blue-500 text-sm" onclick="showInfoModal('batch_size')"
                title="Info about Batch Size">ⓘ</button>
            </label>
            <input type="number" id="batch_size"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-md rounded-lg block w-full p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
              placeholder="{{ batch_size }}" value="{{ batch_size }}" />
          </div>

        </div>
        <hr class="my-4 border-gray-600">
        <button type="submit"
          class="text-white bg-blue-700 max-w-[140px] hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-md w-full sm:w-auto px-5 py-2.5 text-center mb-3">Run
          Screener</button>
        <div>
          <button type="button" id="loadExampleBtn"
            class="text-white max-w-[140px] bg-green-600 hover:bg-green-800 font-medium rounded-lg text-md w-full sm:w-auto px-5 py-2.5 text-center">See
            Example</button>
          <button type="button" class="text-blue-500 text-sm" onclick="showInfoModal('load_example')"
            title="Info about Load Example">ⓘ</button>
        </div>
      </form>
    </div>
    <div id="spinner" class="hidden p-2.5">⏳ Running...</div>
  </div>
  <!-- Drag bar -->
  <div id="dragbar"
    class="w-1 cursor-ew-resize bg-zinc-700 hover:bg-blue-500 transition-all duration-200 ease-in-out z-20 hover:w-2"
    style="position: relative;"></div>
  <!-- Right: Output -->
  <div id="outputarea" class="flex-1 min-w-[300px] bg-zinc-900 p-8 transition-all duration-100 ease-in-out">
    <button id="showJsonBtn"
      class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-md w-full sm:w-auto px-5 py-2.5 text-center mb-4"
      style="display:none;">Show raw JSON</button>
    <div id="output" class="w-full">
      <div class="flex flex-col h-full py-5">
        <h1 class="text-3xl font-bold text-white mb-4">Thematic Screener</h1>
        <p class="mb-4">
          Systematically connects companies to investment themes using unstructured data
          from millions of documents.
        </p>

        <h2 class="text-2xl font-bold text-white mb-4">HOW TO USE:</h2>
        <h2 class="text-xl font-bold text-blue-100 mb-4 pl-4">Option 1: Quick Start</h2>
        <ol class="list-decimal mb-4 pl-10">
          <li>Click <strong>"See Example"</strong> to explore a pre-configured analysis with sample data</li>
          <li>Perfect for first-time users to understand the tool's capabilities</li>
        </ol>
        <h2 class="text-xl font-bold text-blue-100 mb-4 pl-4">Option 2: Custom Analysis</h2>
        <ol class="list-decimal mb-4 pl-10">
          <li>Configure your screening parameters in the sidebar</li>
          <li>Click <strong>"Run Screener"</strong> to begin analysis</li>
          <li>Monitor the logs below to see the process working in the background</li>
          <li>Results will appear below once processing is complete</li>
        </ol>

        <h2 class="text-2xl font-bold text-white mb-4">CURRENT LIMITATIONS:</h2>
        <ul class="list-disc mb-4 pl-6">
          <li>Demo version retrieves <strong>TRANSCRIPT</strong> documents only, restricted to 4 temporal buckets
            (e.g.,
            4 quarters)</li>
          <li>Processing may take a few minutes for complex queries</li>
          <li>This is an experimental tool – results should be validated independently before making investment
            decisions</li>
        </ul>
        <p><strong>New users</strong>: We recommend starting with <strong>"See Example"</strong> to see the screener
          in
          action before
          running your own analysis.<br></p>
        <p class="">
          Check our repo
          <a href="https://github.com/Bigdata-com/bigdata-cookbook" target="_blank"
            class="font-bold hover:text-blue-200">
            https://github.com/Bigdata-com/bigdata-cookbook
          </a> for the complete and customizable version.
        </p>
      </div>
    </div>
  </div>
</div>
<!-- Logs below both -->
<div
  class="my-8 bg-gradient-to-br from-zinc-900 to-zinc-800 rounded-lg shadow-2xl p-6 text-zinc-100 border border-zinc-700"
  style="width: 100%;">
  <h2 class="text-lg font-bold mb-4 text-sky-400 flex items-center gap-2">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
      </path>
    </svg>
    Process Logs
  </h2>
  <div id="logViewer"
    class="bg-black/30 border border-slate-600 rounded-lg p-4 h-64 overflow-y-auto font-mono text-sm whitespace-pre-wrap break-words text-zinc-100 shadow-inner">
  </div>
</div>

<!-- Modal for JSON output -->
<div id="jsonModal" class="hidden fixed z-[1000] inset-0 w-screen h-screen bg-black/70 backdrop-blur-sm">
  <div class="bg-white relative my-20 mx-auto p-6 rounded-xl w-4/5 max-w-[900px] shadow-2xl border border-gray-200">
    <button id="copyBtn" onclick="copyJson()"
      class="absolute top-4 right-14 text-sm px-4 py-2 cursor-pointer text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors font-medium">Copy</button>
    <button onclick="closeModal()"
      class="absolute top-4 right-4 text-2xl text-gray-600 hover:text-gray-900 w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors">&times;</button>
    <h2 class="text-gray-900 text-xl font-bold mb-4">Raw JSON Output</h2>
    <pre id="jsonContent"
      class="bg-gray-900 text-gray-100 p-4 whitespace-pre-wrap break-words overflow-auto rounded-lg mt-2 border border-gray-700"
      style="max-height:60vh;"></pre>
  </div>
</div>
<script>
  // Info modal content for each label


  const watchlists = {{ example_watchlists | tojson }};

  // Populate the dropdown with watchlists
  const comp_select = document.getElementById('companies');
  const comp_text = document.getElementById('companies_text');
  watchlists.forEach((watchlist, index) => {
    if (watchlist.id === "{{ companies }}") {
      comp_text.value = watchlist.name;
    }
    const option = document.createElement('option');
    option.value = watchlist.id;
    option.textContent = watchlist.name;
    comp_select.appendChild(option);
  });

  document.getElementById('showJsonBtn').onclick = function () {
    if (lastReport) {
      document.getElementById('jsonContent').textContent = JSON.stringify(lastReport, null, 2);
      document.getElementById('jsonModal').style.display = 'block';
    }
  };

  window.closeModal = closeModal;

  window.toggleMotivation = toggleMotivation;

  // Load Example button functionality
  document.getElementById('loadExampleBtn').onclick = async function () {
    const requestId = "{{ example_request_id }}";
    await loadRequestId(requestId);
  };
</script>
<script src="static/scripts/form.js"></script>
<script src="static/scripts/load_example.js"></script>
</form>
{% endblock %}