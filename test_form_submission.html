<!DOCTYPE html>
<html>
<head>
    <title>Test Form Submission</title>
</head>
<body>
    <h1>Testing Form Submission Payload</h1>
    <div id="output"></div>
    
    <script>
        // Simulate form data
        const theme = "Artificial Intelligence";
        const focus = "Machine learning and AI applications";
        const companies = "44118802-9104-4265-b97a-2e6d88d74893"; // Top 100 US watchlist
        const start_date = "2023-10-14";
        const end_date = "2024-10-14";
        let fiscal_year = "2024,2025";
        
        // Process fiscal_year like the form does
        if (fiscal_year.includes(',')) {
            fiscal_year = fiscal_year.split(',').map(s => s.trim()).filter(Boolean);
            // Check if all entries are numbers
            if (!fiscal_year.every(yr => Number(yr))) {
                console.error('Fiscal Year must be a number or a comma-separated list of numbers.');
            }
        }
        
        const llm_model = "openai::gpt-4o-mini";
        const document_type = "transcripts";
        const frequency = "Y";
        const document_limit = "100";
        const batch_size = "10";
        const rerank_threshold = "";
        
        // Build payload exactly like form.js does
        let payload = {
            theme,
            focus,
            companies: '', // Will be set below
            start_date: start_date,
            end_date: end_date,
            fiscal_year,
            llm_model,
            document_type,
            frequency,
            document_limit: document_limit ? parseInt(document_limit) : undefined,
            batch_size: batch_size ? parseInt(batch_size) : undefined
        };
        
        // A list of companies
        if (companies.includes(',')) {
            payload.companies = companies.split(',').map(s => s.trim()).filter(Boolean);
        } else if (companies.length === 6) {
            payload.companies = [companies];
        } else if (companies.length > 6) {
            payload.companies = companies;
        }
        
        if (rerank_threshold) payload.rerank_threshold = parseFloat(rerank_threshold);
        
        console.log('Test Payload:', JSON.stringify(payload, null, 2));
        
        document.getElementById('output').innerHTML = `
            <h2>Generated Payload:</h2>
            <pre style="background: #f5f5f5; padding: 20px; border-radius: 8px;">${JSON.stringify(payload, null, 2)}</pre>
            
            <h2>Validation:</h2>
            <ul>
                <li>theme: ${payload.theme ? '✅' : '❌'}</li>
                <li>focus: ${payload.focus ? '✅' : '❌'}</li>
                <li>companies: ${payload.companies ? '✅' : '❌'} (${typeof payload.companies})</li>
                <li>start_date: ${payload.start_date ? '✅' : '❌'}</li>
                <li>end_date: ${payload.end_date ? '✅' : '❌'}</li>
                <li>fiscal_year: ${payload.fiscal_year ? '✅' : '❌'} (${typeof payload.fiscal_year}, ${Array.isArray(payload.fiscal_year) ? 'array' : 'not array'})</li>
            </ul>
            
            <h2>Backend Requirements:</h2>
            <ul>
                <li>✅ theme: string (required)</li>
                <li>✅ focus: string | null</li>
                <li>✅ companies: list[str] | str (required)</li>
                <li>✅ start_date: string (required)</li>
                <li>✅ end_date: string (required)</li>
                <li>✅ fiscal_year: int | list[int] | None (required for transcripts)</li>
            </ul>
            
            <button onclick="testSubmit()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 20px;">
                Test Submit to Backend
            </button>
        `;
        
        async function testSubmit() {
            console.log('Submitting to backend...');
            try {
                const response = await fetch('http://localhost:8000/thematic-screener', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Error:', errorData);
                    alert('Error: ' + JSON.stringify(errorData, null, 2));
                } else {
                    const data = await response.json();
                    console.log('Success:', data);
                    alert('Success! Request ID: ' + data.request_id);
                }
            } catch (err) {
                console.error('Request failed:', err);
                alert('Request failed: ' + err.message);
            }
        }
        
        window.testSubmit = testSubmit;
    </script>
</body>
</html>

